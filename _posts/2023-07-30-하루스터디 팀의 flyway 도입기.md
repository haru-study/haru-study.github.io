---
title:  "하루스터디 팀의 flyway 도입기"
excerpt: "하루스터디 팀의 flyway 도입 과정을 기술했습니다."

categories:
  - flyway, Backend
tags:
  - [flyway, DB]

toc: true
toc_sticky: true
 
date: 2023-07-30
last_modified_at: 2023-07-30
---

> 이 글은 백엔드 크루 테오가 작성했습니다.
>

## 도입 배경

하루스터디 팀은 2차 스프린트까지의 기능 구현을 모두 마치고 운영 서버로의 배포를 준비하고 있는 상황입니다. 운영 서버로 배포를 하게 된다면, 테스트용 데이터베이스가 아닌 실제 운영 데이터베이스를 사용하게 됩니다.

<div style="text-align: center">
<img src="https://github.com/haru-study/haru-study.github.io/assets/78679830/9a5260d2-7b88-4033-91d8-8fd82d8018e0">
</div>
이 과정에서 하루스터디 팀은 flyway를 도입하기로 결정했는데요, 대표적인 요인은 다음과 같습니다.

### 1. 직접적인 DDL 조작의 위험성

운영 데이터베이스를 사용하는 순간부터는 DDL을 통한 조작이 상당히 번거롭고 위험해집니다. 실제 사용자의 데이터가 저장된 터라 휴먼 에러가 발생하는 순간 치명적인 서비스 결함으로 이어질 수 있습니다.

### 2. 데이터베이스 접근이 번거로움

현재 하루스터디 팀의 MySQL 서버는 VPC 내의 private 주소로만 접근이 가능한 상태입니다. 또한, 현재 정책 상 해당 VPC으로의 접근은 우아한테크코스 캠퍼스에서만 이루어질 수 있으므로 데이터베이스 서버로 접근하기가 번거로운 상황입니다.

### 3. 형상관리의 어려움

손수 DDL을 작성하는 경우, 데이터베이스의 변경사항을 추적하기 어렵습니다. flyway의 경우 버전관리용 테이블(schema history table)을 제공해서 어떤 변경사항이 있었는지를 쉽게 추적할 수 있습니다.

### 4. 잦은 데이터베이스 스키마 변경

하루스터디 팀은 매 스프린트마다 기능을 추가하고 있는 상황이고, 이에 따라 데이터베이스 스키마 변경도 잦은 상황입니다. 그리고 이는 위에서 설명한 나머지 문제들과 연계됩니다.



## Spring Boot와 Flyway

스프링 부트에서는 간단한 설정만으로 flyway와 통합해서 사용할 수 있습니다. 하루스터디 팀이 어떻게 flyway 설정을 했는지 간략하게 소개하도록 하겠습니다.

### 의존성 설정

build.gradle에 `flyway-core` 의존성을 추가해줍니다. MariaDB를 사용하거나 MySQL 8.0 이상의 버전을 사용하는 경우에는 추가적으로 `flyway-mysql` 의존성을 추가해줘야 합니다. 현재 하루스터디는 MySQL 8.0.33을 사용하고 있으므로 `flyway-mysql` 도 추가해줍니다.

```java
implementation 'org.flywaydb:flyway-core'
implementation 'org.flywaydb:flyway-mysql'
```

추가적으로, 따로 버전을 명시하지 않은 이유는 `flyway-core` 와 `flyway-mysql` 이 아래처럼 spring boot dependency management의 관리 대상이기 때문입니다.

<div style="text-align: center">
<img src="https://github.com/haru-study/haru-study.github.io/assets/78679830/1783ce34-54c2-4ad3-9584-204a5d78b07a">
</div>


<div style="text-align: center">
<img src="https://github.com/haru-study/haru-study.github.io/assets/78679830/21153f09-a671-4e21-a48d-6a4895001608">
</div>


### application.yml에 flyway 설정 추가

application.yml에 아래와 같이 flyway를 활성화시키는 설정을 추가합니다. 사실 디폴트 값 자체가 `true` 라 추가하지 않아도 무방하지만 명시적인 효과를 위해 추가했습니다.

```java
spring:
	flyway:
    enabled: true
```

### 마이그레이션 스크립트 작성

이후 아래와 같이 마이그레이션 스크립트를 작성합니다.

```sql
// V1.0__init.sql
create table member
(
    id                 bigint       not null auto_increment,
    created_date       datetime(6)  not null,
    last_modified_date datetime(6)  not null,
    nickname           varchar(255) not null,
    primary key (id)
);

...
```

다만 마이그레이션 스크립트를 작성할 때 파일명이 특정 형태를 따르지 않을 경우 flyway에서 인식하지 못하므로 유의해야 합니다. (참고: [Flyway Migrations](https://documentation.red-gate.com/fd/migrations-184127470.html))

<div style="text-align: center">
<img src="https://github.com/haru-study/haru-study.github.io/assets/78679830/2e40131a-48af-42de-9f25-7441672161fd">
</div>

마이그레이션 스크립트가 저장되어야 하는 기본 경로는 `resources/db/migration` 인데요, 이 경로를 수정하고자 한다면 아래와 같이 `spring.flyway.locations` 를 수정하면 됩니다. 하루스터디의 경우에는 기본 경로를 사용하고 있습니다.

```java
spring:
	flyway:
		locations: classpath:customDirectory/migration
```

### schema history table 확인하기

<div style="text-align: center">
<img src="https://github.com/haru-study/haru-study.github.io/assets/78679830/88025ea3-a2a9-4c05-ba85-c86a6bb8a28f">
</div>

연결이 정상적으로 되었다면 `flyway_schema_history`라는 테이블이 생성되고, 실행된 마이그레이션 스크립트들에 대한 정보가 기록됩니다.

이외에도 `checksum` 등의 정보가 기록되어, 마이그레이션 스크립트가 혹여나 변경되었는지를 감지할 수 있습니다. 만약 변경되었다면 마이그레이션 스크립트가 실행되지 않습니다.

## 마이그레이션 스크립트 버저닝 전략

마이그레이션 파일을 작성하게 되면 버전을 명시해야 합니다. flyway는 버전을 숫자로 인식해서 낮은 순부터 순차적으로 마이그레이션 스크립트를 실행합니다.

하루스터디의 경우 메이저 버전과 마이너 버전을 통해 마이그레이션 스크립트를 관리하기로 결정했습니다.(ex. V1.0, V1.1 ..) `CREATE` 문이나 `DROP` 등의 대규모 변경이 있을 때에는 메이저 버전을 늘리고, 컬럼을 추가하는 등과 같은 `ALTER` 문의 경우에는 마이너 버전을 늘리도록 논의를 마친 상태입니다.

## 마치며

이번 아티클을 통해 하루스터디 팀이 flyway를 도입한 이유부터 어떤 버저닝 전략을 사용하고 있는지까지 알아보았습니다.

감사합니다.

## 참고 자료
[Dependency Versions](https://docs.spring.io/spring-boot/docs/current/reference/html/dependency-versions.html#appendix.dependency-versions.coordinates)

[Migrations - Flyway - Product Documentation](https://documentation.red-gate.com/fd/migrations-184127470.html)

[MySQL - Flyway - Product Documentation](https://documentation.red-gate.com/fd/mysql-184127601.html)

[Spring Boot Flyway DB Migration Integration Example](https://www.code4copy.com/java/spring-boot-flyway-db-migration-integration-example/)